generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPERADMIN
  ADMIN
  MIS_WAREHOUSE_EXECUTIVE
  WAREHOUSE_MANAGER
  INSPECTION_ENGINEER
  REPAIR_ENGINEER          // @deprecated - use L2_ENGINEER instead, kept for migration
  L2_ENGINEER              // Coordinates all repair work (replaces REPAIR_ENGINEER)
  L3_ENGINEER              // Major repairs: motherboard, locks, power issues
  DISPLAY_TECHNICIAN       // Display/screen repairs
  BATTERY_TECHNICIAN       // Battery boosting/replacement
  PAINT_SHOP_TECHNICIAN
  QC_ENGINEER
}

enum DeviceCategory {
  LAPTOP
  DESKTOP
  WORKSTATION
  SERVER
  MONITOR
  STORAGE
  NETWORKING_CARD
}

enum Ownership {
  REFURB_STOCK
  RENTAL_RETURN
}

enum DeviceStatus {
  RECEIVED
  PENDING_INSPECTION
  WAITING_FOR_SPARES
  READY_FOR_REPAIR
  UNDER_REPAIR
  IN_PAINT_SHOP
  AWAITING_QC
  QC_PASSED
  QC_FAILED_REWORK
  READY_FOR_STOCK
  STOCK_OUT_SOLD
  STOCK_OUT_RENTAL
  SCRAPPED
}

enum InwardType {
  REFURB_PURCHASE
  RENTAL_RETURN
}

enum RepairStatus {
  PENDING_INSPECTION
  WAITING_FOR_SPARES
  READY_FOR_REPAIR
  UNDER_REPAIR
  IN_PAINT_SHOP
  AWAITING_QC
  REPAIR_CLOSED
}

enum PaintStatus {
  AWAITING_PAINT
  IN_PAINT
  READY_FOR_COLLECTION
  FITTED
}

enum QCStatus {
  PASSED
  FAILED_REWORK
}

enum Grade {
  A
  B
}

// New enums for inspection checklist and parallel work
enum ChecklistStatus {
  PENDING
  PASS
  FAIL
  NOT_APPLICABLE
}

enum ChecklistStage {
  INSPECTION
  L2_ENGINEER
  L3_ENGINEER
  QC
}

enum L3IssueType {
  MOTHERBOARD
  DOMAIN_LOCK
  BIOS_LOCK
  POWER_ON_ISSUE
}

enum ParallelWorkStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MovementType {
  INWARD
  MOVE
  SALES_OUTWARD
  RENTAL_OUTWARD
  RETURN_TO_VENDOR
  SCRAP
}

enum OutwardType {
  SALES
  RENTAL
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String
  role      Role
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete - null means not deleted

  // Relations
  createdBatches    InwardBatch[]
  inspections       RepairJob[]      @relation("InspectionEngineer")
  repairs           RepairJob[]      @relation("RepairEngineer")
  l2Assignments     RepairJob[]      @relation("L2Engineer")
  paintWork         PaintPanel[]
  qcInspections     QCRecord[]       @relation("QCEngineer")
  movements         StockMovement[]
  packedOutwards    OutwardRecord[]  @relation("PackedBy")
  checkedOutwards   OutwardRecord[]  @relation("CheckedBy")
  activityLogs      ActivityLog[]

  // New relations for checklist and parallel work
  checklistChecks   InspectionChecklistItem[]
  displayRepairs    DisplayRepairJob[]
  batteryBoosts     BatteryBoostJob[]
  l3Repairs         L3RepairJob[]
}

model Device {
  id              String         @id @default(cuid())
  barcode         String         @unique
  category        DeviceCategory
  brand           String
  model           String

  // Common hardware specifications (Laptop/Desktop/Workstation)
  cpu             String?
  ram             String?
  ssd             String?
  gpu             String?
  screenSize      String?

  // Server-specific fields
  formFactor      String?        // e.g., 1U rack, 2U rack, Tower
  raidController  String?        // e.g., P408i-a, RAID 5
  networkPorts    String?        // e.g., 4× 1GbE + 2× 10GbE

  // Monitor-specific fields
  monitorSize     String?        // e.g., 24 inch
  resolution      String?        // e.g., 1920×1080
  panelType       String?        // e.g., IPS, TN, VA
  refreshRate     String?        // e.g., 75Hz, 144Hz
  monitorPorts    String?        // e.g., HDMI + DisplayPort + VGA

  // Storage-specific fields
  storageType     String?        // HDD / SSD / NVMe
  capacity        String?        // e.g., 1TB, 500GB
  storageFormFactor String?      // e.g., 2.5", 3.5", M.2
  interface       String?        // e.g., SATA, SAS, PCIe Gen4
  rpm             String?        // e.g., 7200 RPM (for HDD only)

  // Networking Card-specific fields
  nicSpeed        String?        // e.g., 10GbE, 25GbE
  portCount       String?        // e.g., 2-port, 4-port
  connectorType   String?        // e.g., RJ45, SFP+, QSFP+
  nicInterface    String?        // e.g., PCIe x8
  bracketType     String?        // e.g., Low Profile / Full Height

  serial          String?
  conditionNotes  String?
  ownership       Ownership
  status          DeviceStatus   @default(RECEIVED)
  location        String?        // Rack/Bin
  grade           Grade?         // Only set after QC Passed

  // Workflow flags - set during inspection
  repairRequired  Boolean        @default(false)
  paintRequired   Boolean        @default(false)
  repairCompleted Boolean        @default(false)
  paintCompleted  Boolean        @default(false)

  // Parallel work flags - set by L2 Engineer
  displayRepairRequired  Boolean @default(false)
  batteryBoostRequired   Boolean @default(false)
  l3RepairRequired       Boolean @default(false)
  displayRepairCompleted Boolean @default(false)
  batteryBoostCompleted  Boolean @default(false)
  l3RepairCompleted      Boolean @default(false)

  // References
  poInvoiceNo     String?        // For Refurb
  rentalRef       String?        // For Rental Return

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  inwardBatchId   String
  inwardBatch     InwardBatch    @relation(fields: [inwardBatchId], references: [id])
  repairJobs      RepairJob[]
  paintPanels     PaintPanel[]
  qcRecords       QCRecord[]
  movements       StockMovement[]
  outwardRecordId String?
  outwardRecord   OutwardRecord? @relation(fields: [outwardRecordId], references: [id])

  // New relations for checklist and parallel work
  inspectionChecklist InspectionChecklistItem[]
  displayRepairJobs   DisplayRepairJob[]
  batteryBoostJobs    BatteryBoostJob[]
  l3RepairJobs        L3RepairJob[]

  // Performance indexes
  @@index([status])
  @@index([grade])
  @@index([category])
  @@index([inwardBatchId])
}

model InwardBatch {
  id              String      @id @default(cuid())
  batchId         String      @unique // Human readable ID
  type            InwardType
  date            DateTime    @default(now())
  
  // Refurb fields
  poInvoiceNo     String?
  supplier        String?
  
  // Rental fields
  customer        String?
  rentalRef       String?
  emailSubject    String?
  emailThreadId   String?
  
  createdById     String
  createdBy       User        @relation(fields: [createdById], references: [id])
  
  devices         Device[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model SparePart {
  id              String      @id @default(cuid())
  partCode        String      @unique
  description     String
  category        String
  compatibleModels String?    // Comma separated or JSON
  minStock        Int         @default(0)
  maxStock        Int         @default(100)
  currentStock    Int         @default(0)
  binLocation     String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model RepairJob {
  id              String       @id @default(cuid())
  jobId           String       @unique
  deviceId        String
  device          Device       @relation(fields: [deviceId], references: [id])

  inspectionEngId String?
  inspectionEng   User?        @relation("InspectionEngineer", fields: [inspectionEngId], references: [id])

  repairEngId     String?
  repairEng       User?        @relation("RepairEngineer", fields: [repairEngId], references: [id])

  // L2 Engineer who owns this device throughout the repair cycle
  l2EngineerId    String?
  l2Engineer      User?        @relation("L2Engineer", fields: [l2EngineerId], references: [id])

  reportedIssues  String?      // JSON or text
  rootCause       String?
  sparesRequired  String?      // JSON list of part codes
  sparesIssued    String?      // JSON list

  // Recommended paint panels from inspection (JSON array of panel names)
  // These are suggestions - L2 Engineer must explicitly send to paint
  recommendedPaintPanels String?

  station         String?

  repairStartDate DateTime?
  repairEndDate   DateTime?
  tatDueDate      DateTime?

  status          RepairStatus @default(PENDING_INSPECTION)
  notes           String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Performance indexes
  @@index([status])
  @@index([tatDueDate])
  @@index([repairEngId])
  @@index([deviceId])
}

model PaintPanel {
  id              String      @id @default(cuid())
  deviceId        String
  device          Device      @relation(fields: [deviceId], references: [id])
  
  panelType       String      // Top Cover, Bottom Cover, etc.
  status          PaintStatus @default(AWAITING_PAINT)
  
  technicianId    String?
  technician      User?       @relation(fields: [technicianId], references: [id])
  
  startedAt       DateTime?
  completedAt     DateTime?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model QCRecord {
  id              String      @id @default(cuid())
  deviceId        String
  device          Device      @relation(fields: [deviceId], references: [id])
  
  qcEngId         String
  qcEng           User        @relation("QCEngineer", fields: [qcEngId], references: [id])
  
  // Snapshot of who did what
  inspectionEngName String?
  repairEngName     String?
  
  checklistResults String?    // JSON: { functional: {}, cosmetic: {} }
  attachments      String?    // JSON: URLs
  remarks          String?
  
  finalGrade       Grade
  status           QCStatus

  completedAt      DateTime   @default(now())

  // Performance indexes
  @@index([status])
  @@index([qcEngId])
  @@index([deviceId])
  @@index([completedAt])
}

model StockMovement {
  id              String       @id @default(cuid())
  deviceId        String
  device          Device       @relation(fields: [deviceId], references: [id])
  
  type            MovementType
  fromLocation    String?
  toLocation      String?
  reference       String?      // Batch ID, Invoice No, etc.
  
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  
  date            DateTime     @default(now())
}

model OutwardRecord {
  id              String      @id @default(cuid())
  outwardId       String      @unique
  type            OutwardType
  
  customer        String
  reference       String      // Invoice No or Rental Ref
  date            DateTime    @default(now())
  
  shippingDetails String?
  
  packedById      String?
  packedBy        User?       @relation("PackedBy", fields: [packedById], references: [id])
  
  checkedById     String?
  checkedBy       User?       @relation("CheckedBy", fields: [checkedById], references: [id])
  
  devices         Device[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model ActivityLog {
  id        String   @id @default(cuid())
  action    String   // e.g., "CREATED_INWARD", "UPDATED_REPAIR"
  details   String?  // Human readable description

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  metadata  String?  // JSON for extra data (e.g., deviceId, batchId)

  createdAt DateTime @default(now())
}

// =====================================================
// NEW MODELS FOR WORKFLOW RESTRUCTURING
// =====================================================

// Inspection checklist items - category-specific, flows through L2/L3/QC
model InspectionChecklistItem {
  id              String          @id @default(cuid())
  deviceId        String
  device          Device          @relation(fields: [deviceId], references: [id])

  itemIndex       Int             // Order within the category (1-20)
  itemText        String          // The actual checklist item text

  status          ChecklistStatus @default(PENDING)
  notes           String?         // Optional notes for this item

  checkedById     String?
  checkedBy       User?           @relation(fields: [checkedById], references: [id])
  checkedAt       DateTime?
  checkedAtStage  ChecklistStage  @default(INSPECTION)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([deviceId, itemIndex])
  @@index([deviceId])
}

// Display repair jobs - assigned by L2 to Display Technician or done by L2
model DisplayRepairJob {
  id              String             @id @default(cuid())
  deviceId        String
  device          Device             @relation(fields: [deviceId], references: [id])

  reportedIssues  String?            // Display-specific issues
  status          ParallelWorkStatus @default(PENDING)

  assignedToId    String?
  assignedTo      User?              @relation(fields: [assignedToId], references: [id])

  startedAt       DateTime?
  completedAt     DateTime?
  notes           String?
  completedByL2   Boolean            @default(false) // True if L2 did it themselves

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([deviceId])
}

// Battery boost jobs - assigned by L2 to Battery Technician or done by L2
model BatteryBoostJob {
  id              String             @id @default(cuid())
  deviceId        String
  device          Device             @relation(fields: [deviceId], references: [id])

  initialCapacity String?            // e.g., "45%"
  targetCapacity  String?            // e.g., "70%"
  status          ParallelWorkStatus @default(PENDING)

  assignedToId    String?
  assignedTo      User?              @relation(fields: [assignedToId], references: [id])

  startedAt       DateTime?
  completedAt     DateTime?
  finalCapacity   String?            // Actual capacity after boost
  notes           String?
  completedByL2   Boolean            @default(false) // True if L2 did it themselves

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([deviceId])
}

// L3 repair jobs - major repairs assigned by L2 to L3 Engineer
model L3RepairJob {
  id              String             @id @default(cuid())
  deviceId        String
  device          Device             @relation(fields: [deviceId], references: [id])

  issueType       L3IssueType        // MOTHERBOARD, DOMAIN_LOCK, BIOS_LOCK, POWER_ON_ISSUE
  description     String?            // Detailed description of the issue
  status          ParallelWorkStatus @default(PENDING)

  assignedToId    String?
  assignedTo      User?              @relation(fields: [assignedToId], references: [id])

  startedAt       DateTime?
  completedAt     DateTime?
  resolution      String?            // How the issue was resolved
  notes           String?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([deviceId])
}
